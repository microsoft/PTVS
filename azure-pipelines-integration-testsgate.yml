# Don't trigger ci or pr builds
trigger: none
pr: none

# The following steps describe how to create a DartLab pipeline that installs Visual Studio using a bootstrapper generated by the MicroBuild Build VS Bootstrapper task 
# in the component repo's MicroBuild: https://dev.azure.com/devdiv/DevDiv/_wiki/wikis/DevDiv.wiki/45681/Component-Repository
resources:

  pipelines:

  # All PTVS build artifacts come from this pipeline and are referenced like this:
  # $(Pipeline.Workspace)\ComponentBuildUnderTest\<artifactName>\<filePath>
  - pipeline: ComponentBuildUnderTest
    project: DevDiv
    source: Python\PTVS\PTVS-Build

    trigger:
      branches:
        include:
          - main
          - release/*

  - pipeline: DartLab
    project: DevDiv
    source: DartLab
    branch: main

  repositories:

  - repository: DartLabTemplates
    type: git
    name: DartLab.Templates
    ref: refs/heads/main

stages:

- template: stages/cloudtest/visual-studio/single-runsettings.yml@DartLabTemplates
  parameters:
    displayName: Integration Tests
    owner: ptvs
    testMachineLab: DDRITs-PR
    # This assumes the PTVS build has published a build artifact called "RunSettings" that contains the default.runsettings file
    runSettingsURI: https://vsdrop.microsoft.com/file/v1/$(RunSettings.DropName);ptvs.runsettings
    visualStudioBootstrapperURI: $(VisualStudio.InstallationUnderTest.BootstrapperURL)
    visualStudioSigning: Test
    testMachineConfigurationJobVariables:
    - name: VisualStudio.InstallationUnderTest.BootstrapperBranch
      value: main
    # These steps run on the machine that is creating the test machine configuration, which isn't the same
    # as the machine running the actual tests
    preTestMachineConfigurationSteps:

    - download: ComponentBuildUnderTest
      artifact: MicroBuildOutputs
      patterns: '**\BootstrapperInfo.json'
      displayName: Download Bootstrapper Information

    - task: PowerShell@2
      displayName: Set 'VisualStudio.InstallationUnderTest.BootstrapperURL'
      inputs:
        filePath: $(DartLab.Path)\Scripts\VisualStudio\Bootstrapper\Get-BootstrapperURL.ps1
        arguments: -BootstrapperInfoJsonURI '$(Pipeline.Workspace)\ComponentBuildUnderTest\MicroBuildOutputs\BootstrapperInfo.json' -VSBranch '$(VisualStudio.InstallationUnderTest.BootstrapperBranch)' -OutVariableName 'VisualStudio.InstallationUnderTest.BootstrapperURL'

    - download: ComponentBuildUnderTest
      artifact: PTVS-TestData
      patterns: '**\*'
      displayName: Download drop Information

    - download: ComponentBuildUnderTest
      artifact: TestDataFolder
      patterns: '**\*'
      displayName: Download TestDataFolder Information

    - task: PowerShell@2
      displayName: List downloaded files before setting 'RunSettings.DropName'
      inputs:
        targetType: inline
        script: |
          Write-Host "Pipeline.Workspace: $(Pipeline.Workspace)"
          Write-Host "System.DefaultWorkingDirectory: $(System.DefaultWorkingDirectory)"

          $componentRoot = Join-Path "$(Pipeline.Workspace)" "ComponentBuildUnderTest"

          function Write-RecursiveListing {
            param(
              [Parameter(Mandatory = $true)][string]$RootPath,
              [Parameter(Mandatory = $true)][string]$Title
            )

            Write-Host ""
            Write-Host "==== $Title ===="
            Write-Host "Root: $RootPath"

            if (-not (Test-Path -LiteralPath $RootPath)) {
              Write-Warning "Path not found: $RootPath"
              return
            }

            Write-Host "Top-level entries:"
            Get-ChildItem -LiteralPath $RootPath -Force |
              Select-Object Name, FullName, Mode, Length, LastWriteTime |
              Sort-Object FullName |
              Format-Table -AutoSize

            Write-Host ""
            Write-Host "All files (recursive):"
            $allFiles = Get-ChildItem -LiteralPath $RootPath -Recurse -Force -File -ErrorAction SilentlyContinue
            if ($allFiles) {
              $allFiles |
                Select-Object FullName, Length, LastWriteTime |
                Sort-Object FullName |
                Format-Table -AutoSize
              Write-Host "Total files: $($allFiles.Count)"
            } else {
              Write-Warning "No files found under: $RootPath"
            }

            Write-Host ""
            Write-Host "All directories (recursive):"
            $allDirs = Get-ChildItem -LiteralPath $RootPath -Recurse -Force -Directory -ErrorAction SilentlyContinue
            if ($allDirs) {
              $allDirs |
                Select-Object FullName, LastWriteTime |
                Sort-Object FullName |
                Format-Table -AutoSize
              Write-Host "Total directories: $($allDirs.Count)"
            } else {
              Write-Warning "No directories found under: $RootPath"
            }
          }

          Write-RecursiveListing -RootPath $componentRoot -Title "Downloaded artifacts under ComponentBuildUnderTest"

          Write-Host ""
          Write-Host "Searching for VSTSDrop.json under: $componentRoot"
          if (Test-Path -LiteralPath $componentRoot) {
            $matches = Get-ChildItem -LiteralPath $componentRoot -Recurse -Force -File -Filter "VSTSDrop.json" -ErrorAction SilentlyContinue
            if ($matches) {
              $matches | Select-Object FullName, Length, LastWriteTime | Sort-Object FullName | Format-Table -AutoSize
            } else {
              Write-Warning "No VSTSDrop.json found under: $componentRoot"
            }
          } else {
            Write-Warning "Path not found: $componentRoot"
          }

    - task: PowerShell@2
      displayName: Find VSTSDrop.json path
      inputs:
        targetType: inline
        script: |
          $componentRoot = Join-Path "$(Pipeline.Workspace)" "ComponentBuildUnderTest"
          Write-Host "Searching for VSTSDrop.json under: $componentRoot"
          if (-not (Test-Path -LiteralPath $componentRoot)) {
            throw "ComponentBuildUnderTest root not found: $componentRoot"
          }

          $matches = Get-ChildItem -LiteralPath $componentRoot -Recurse -Force -File -Filter "VSTSDrop.json" -ErrorAction SilentlyContinue
          if (-not $matches) {
            throw "No VSTSDrop.json found under: $componentRoot"
          }

          if ($matches.Count -gt 1) {
            Write-Warning "Multiple VSTSDrop.json files found; selecting the most recent."
            $matches | Select-Object FullName, Length, LastWriteTime | Sort-Object LastWriteTime -Descending | Format-Table -AutoSize
          }

          $selected = $matches | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          Write-Host "Selected VSTSDrop.json: $($selected.FullName)"
          Write-Host "##vso[task.setvariable variable=VSTSDropJsonURI]$($selected.FullName)"


    - template: Build/azuredevops/test/uitest-integration-stage.yml
      parameters:
        BinariesDirectory: Run UI Tests
        Drop: $(Pipeline.Workspace)\ComponentBuildUnderTest\
        TestFilterCriteria: $(Pipeline.Workspace)\UITestResults
        UITestNames: PTVS UI Tests

    - template: \steps\powershell\execute-script.yml@DartLabTemplates
      parameters:
        displayName: Set 'RunSettings.DropName'
        filePath: $(DartLab.Path)\Scripts\AzureDevOps\Artifacts\Drop\Get-DropName.ps1
        arguments: -VSTSDropJsonURI '$(VSTSDropJsonURI)' -OutVariableName 'RunSettings.DropName'

    - task: PowerShell@2
      displayName: Debug arguments for 'Set RunSettings.DropName'
      inputs:
        targetType: inline
        script: |
          Write-Host "Resolved arguments for Get-DropName.ps1:"
          Write-Host "  -VSTSDropJsonURI '$($("VSTSDropJsonURI"))'"
          Write-Host "  -OutVariableName 'RunSettings.DropName'"
          Write-Host ""
          Write-Host "Raw argument string (as authored in YAML):"
          Write-Host "  -VSTSDropJsonURI '$(VSTSDropJsonURI)' -OutVariableName 'RunSettings.DropName'"
          Write-Host ""
          $path = "$(VSTSDropJsonURI)"
          Write-Host "VSTSDropJsonURI points to: $path"
          if ([string]::IsNullOrWhiteSpace($path)) {
            Write-Warning "VSTSDropJsonURI is empty."
          } elseif (Test-Path -LiteralPath $path) {
            Write-Host "VSTSDropJsonURI exists on disk."
          } else {
            Write-Warning "VSTSDropJsonURI does not exist on disk (it may be a URI or incorrect path)."
          }
 