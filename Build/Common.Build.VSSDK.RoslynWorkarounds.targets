<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Target Name="GeneratePkgDef"
          Inputs="$(TargetPath)"
          Outputs="$(IntermediateOutputPath)$(TargetName).pkgdef"
          Condition="'$(GeneratePkgDefFile)'=='true'"
          DependsOnTargets="$(GeneratePkgDefDependsOn)">

    <Message Importance="High" Text="Creating intermediate PkgDef file." />

    <ItemGroup>
      <_MyReferences Include="@(ReferencePath)" Condition="!$([System.String]::new(`%(Filename)`).StartsWith(`Microsoft.VisualStudio.Text.`))" />
      <_MyReferences Include="$(DevEnvDir)\CommonExtensions\Microsoft\Editor\Microsoft.VisualStudio.Text.*.dll" />
    </ItemGroup>
    <Message Text="@(_MyReferences->'%(FullPath)', '
')" Importance="high" />

    <CreatePkgDef AssemblyToProcess="$(TargetPath)"
              ProductVersion="$(TargetVSVersion)"
              SDKVersion="$(VsSDKVersion)"
              OutputFile="$(IntermediateOutputPath)$(TargetName).latest.pkgdef"
              UseCodebase="$(UseCodebase)"
              ReferencedAssemblies="@(_MyReferences)"  />
    <CopyIfChanged Condition="Exists('$(IntermediateOutputPath)$(TargetName).latest.pkgdef')"
                   SourceFile="$(IntermediateOutputPath)$(TargetName).latest.pkgdef"
                   DestinationFile="$(IntermediateOutputPath)$(TargetName).pkgdef" />

    <!-- If the CTO file was changed, touch the pkgdef file to cause a re-merge -->
    <Touch Files="$(IntermediateOutputPath)$(TargetName).pkgdef"
           Condition="'$(CTOFileHasChanged)'=='true' AND Exists('$(IntermediateOutputPath)$(TargetName).pkgdef')" />

    <ItemGroup>
      <FileWrites Include="$(IntermediateOutputPath)$(TargetName).pkgdef" Condition="Exists('$(IntermediateOutputPath)$(TargetName).pkgdef')"/>
      <FileWrites Include="$(IntermediateOutputPath)$(TargetName).latest.pkgdef" Condition="Exists('$(IntermediateOutputPath)$(TargetName).latest.pkgdef')"/>
    </ItemGroup>
  </Target>
</Project>
